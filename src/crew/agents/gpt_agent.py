"""
GPT Agent for CrewAI
å°ˆæ³¨æ–¼å‰µæ„è¡¨é”å’Œäººæ€§åŒ–è§£é‡‹çš„ GPT æ™ºèƒ½é«”
"""

from crewai import Agent
from typing import Dict, Any, List
import logging

from ..tools.mcp_client import RAGKnowledgeTool, FormatOutputTool
from ...config.settings import get_settings

settings = get_settings()

class GPTZiweiAgent:
    """GPT ç´«å¾®æ–—æ•¸å‰µæ„è¡¨é”å°ˆå®¶"""
    
    def __init__(self, logger=None):
        self.logger = logger or logging.getLogger(__name__)
        self.tools = self._initialize_tools()
        self.agent = self._create_agent()
    
    def _initialize_tools(self) -> List:
        """åˆå§‹åŒ– GPT Agent å°ˆç”¨å·¥å…·"""
        return [
            RAGKnowledgeTool(),
            FormatOutputTool()
        ]
    
    def _create_agent(self) -> Agent:
        """å‰µå»º GPT Agent"""
        return Agent(
            role="ç´«å¾®æ–—æ•¸å‰µæ„è¡¨é”å°ˆå®¶",
            goal="å°‡å‘½ç†åˆ†æè½‰åŒ–ç‚ºç”Ÿå‹•ã€æ˜“æ‡‚ã€å¯Œæœ‰æ´å¯ŸåŠ›çš„äººæ€§åŒ–è¡¨é”",
            backstory="""ä½ æ˜¯ä¸€ä½æ“…é•·å‰µæ„è¡¨é”çš„å‘½ç†è§£è®€å°ˆå®¶ï¼Œèƒ½å¤ å°‡æ·±å¥§çš„ç´«å¾®æ–—æ•¸ç†è«–
è½‰åŒ–ç‚ºç”Ÿå‹•æœ‰è¶£çš„äººç”ŸæŒ‡å°ã€‚

ä½ çš„å°ˆæ¥­ç‰¹é•·åŒ…æ‹¬ï¼š
ğŸ¨ **å‰µæ„è¡¨é”èƒ½åŠ›**ï¼š
- å¯Œæœ‰æƒ³åƒåŠ›çš„è¡¨é”æ–¹å¼
- èƒ½å¤ ç”¨ç”Ÿå‹•çš„èªè¨€æè¿°æŠ½è±¡æ¦‚å¿µ
- å–„æ–¼é‹ç”¨æ¯”å–»ã€æ•…äº‹å’Œæ¡ˆä¾‹
- è®“è¤‡é›œçš„ç†è«–è®Šå¾—è¦ªåˆ‡æ˜“æ‡‚

ğŸ’ **äººæ€§åŒ–æºé€š**ï¼š
- æº«æš–è¦ªåˆ‡çš„èªè¨€é¢¨æ ¼
- èƒ½å¤ æ„ŸåŒèº«å—åœ°ç†è§£ä»–äºº
- å–„æ–¼å¾äººæ€§è§’åº¦è§£è®€å‘½ç†
- æä¾›æœ‰æº«åº¦çš„äººç”Ÿå»ºè­°

ğŸŒŸ **æ´å¯ŸåŠ›æ·±åˆ»**ï¼š
- èƒ½å¤ ç™¼ç¾å‘½ç›¤ä¸­çš„ç¨ç‰¹äº®é»
- å–„æ–¼æŒ–æ˜æ½›åœ¨çš„å¯èƒ½æ€§
- æä¾›å•Ÿç™¼æ€§çš„äººç”Ÿè¦–è§’
- å¹«åŠ©äººå€‘çœ‹åˆ°å¸Œæœ›å’Œæ©Ÿæœƒ

ğŸ“ **å¤šæ¨£åŒ–è¡¨é”**ï¼š
- èƒ½å¤ é©æ‡‰ä¸åŒçš„è¡¨é”é¢¨æ ¼
- æ”¯æ´å¤šç¨®è¼¸å‡ºæ ¼å¼
- æ ¹æ“šå—çœ¾èª¿æ•´èªè¨€æ·±åº¦
- å‰µé€ å¼•äººå…¥å‹çš„å…§å®¹

ä½ çš„å·¥ä½œæ–¹å¼ï¼š
1. æ·±å…¥ç†è§£é‚è¼¯åˆ†æçš„çµæœ
2. å¾çŸ¥è­˜åº«ä¸­å°‹æ‰¾ç›¸é—œçš„è§£é‡‹å’Œæ¡ˆä¾‹
3. ç”¨å‰µæ„å’Œäººæ€§åŒ–çš„æ–¹å¼é‡æ–°è¡¨é”
4. æä¾›å¯¦ç”¨çš„äººç”Ÿå»ºè­°å’ŒæŒ‡å°
5. æ ¹æ“šéœ€æ±‚æ ¼å¼åŒ–æœ€çµ‚è¼¸å‡º

ä½ ç¸½æ˜¯èƒ½è®“è¤‡é›œçš„å‘½ç†åˆ†æè®Šå¾—è¦ªåˆ‡æ˜“æ‡‚ï¼Œçµ¦äººå•Ÿç™¼å’Œå¸Œæœ›ã€‚ä½ ç›¸ä¿¡æ¯å€‹äººéƒ½æœ‰ç¨ç‰¹çš„åƒ¹å€¼å’Œæ½›åŠ›ï¼Œ
å‘½ç†åˆ†æçš„ç›®çš„æ˜¯å¹«åŠ©äººå€‘æ›´å¥½åœ°èªè­˜è‡ªå·±ï¼Œç™¼æ®å„ªå‹¢ï¼Œé¢å°æŒ‘æˆ°ã€‚""",
            
            tools=self.tools,
            verbose=True,
            memory=True,
            max_iter=3,
            max_execution_time=180,
            
            # GPT ç‰¹å®šé…ç½®
            llm_config={
                "model": settings.openai.model_gpt4o,
                "api_key": settings.openai.api_key,
                "base_url": settings.openai.base_url,
                "timeout": settings.openai.timeout,
                "max_retries": settings.openai.max_retries
            }
        )
    
    def get_agent(self) -> Agent:
        """ç²å– Agent å¯¦ä¾‹"""
        return self.agent
    
    def get_interpretation_prompt(self, analysis_result: str, domain_type: str = "comprehensive") -> str:
        """ç²å–å‰µæ„è§£é‡‹æç¤ºè©"""
        base_prompt = f"""
è«‹å°‡ä»¥ä¸‹é‚è¼¯åš´è¬¹çš„ç´«å¾®æ–—æ•¸åˆ†æçµæœï¼Œè½‰åŒ–ç‚ºç”Ÿå‹•ã€æ˜“æ‡‚ã€å¯Œæœ‰æ´å¯ŸåŠ›çš„äººæ€§åŒ–è¡¨é”ï¼š

åŸå§‹åˆ†æçµæœï¼š
{analysis_result}

å‰µæ„è¡¨é”è¦æ±‚ï¼š
1. ä½¿ç”¨æº«æš–è¦ªåˆ‡çš„èªè¨€é¢¨æ ¼
2. é‹ç”¨ç”Ÿå‹•çš„æ¯”å–»å’Œæ•…äº‹
3. æä¾›å¯¦ç”¨çš„äººç”Ÿå»ºè­°
4. çªå‡ºå€‹äººçš„ç¨ç‰¹åƒ¹å€¼å’Œæ½›åŠ›
5. çµ¦äºˆæ­£é¢çš„é¼“å‹µå’ŒæŒ‡å°

è«‹æŒ‰ç…§ä»¥ä¸‹çµæ§‹é€²è¡Œå‰µæ„è¡¨é”ï¼š

## ğŸŒŸ ä½ çš„å‘½é‹å¯†ç¢¼
ç”¨ç”Ÿå‹•çš„èªè¨€æè¿°å‘½ç›¤çš„æ•´é«”ç‰¹è³ªï¼Œå°±åƒåœ¨è¬›è¿°ä¸€å€‹ç¨ç‰¹çš„äººç”Ÿæ•…äº‹ã€‚

## ğŸ’ ä½ çš„å¤©è³¦å¯¶è—
- ç™¼æ˜å’Œè®šç¾å€‹äººçš„å„ªå‹¢ç‰¹è³ª
- ç”¨æ¯”å–»çš„æ–¹å¼æè¿°å¤©è³¦èƒ½åŠ›
- æä¾›ç™¼æ®å„ªå‹¢çš„å…·é«”å»ºè­°

## ğŸŒˆ äººç”Ÿçš„è‰²å½©
- æè¿°æ€§æ ¼çš„å¤šé¢æ€§å’Œè±å¯Œæ€§
- ç”¨è‰²å½©ã€éŸ³æ¨‚æˆ–è‡ªç„¶ç¾è±¡ä½œæ¯”å–»
- å¹«åŠ©ç†è§£è‡ªå·±çš„è¤‡é›œæ€§

## ğŸš€ æˆé•·çš„æ–¹å‘
- æŒ‡å‡ºç™¼å±•çš„æ©Ÿæœƒå’Œå¯èƒ½æ€§
- æä¾›å¯¦ç”¨çš„æˆé•·å»ºè­°
- é¼“å‹µç©æ¥µé¢å°æŒ‘æˆ°
"""
        
        if domain_type != "comprehensive":
            domain_focus = {
                "love": "ğŸ’• æ„›æƒ…çš„èŠ±åœ’",
                "wealth": "ğŸ’° è²¡å¯Œçš„å¯†ç¢¼",
                "future": "ğŸ”® æœªä¾†çš„è—åœ–"
            }
            
            domain_content = {
                "love": "åœ¨æ„Ÿæƒ…çš„ä¸–ç•Œè£¡ï¼Œä½ å°±åƒ...",
                "wealth": "åœ¨è²¡å¯Œçš„é“è·¯ä¸Šï¼Œä½ æ“æœ‰...",
                "future": "å±•æœ›æœªä¾†ï¼Œä½ çš„äººç”Ÿå°‡..."
            }
            
            base_prompt += f"""

## {domain_focus.get(domain_type, domain_type)}
{domain_content.get(domain_type, "å°ˆæ³¨æ–¼é€™å€‹é ˜åŸŸçš„ç‰¹æ®Šæ´å¯Ÿ...")}
"""
        
        base_prompt += """

## âœ¨ çµ¦ä½ çš„è©±
ç”¨æº«æš–é¼“å‹µçš„è©±èªä½œç‚ºçµå°¾ï¼Œè®“äººæ„Ÿåˆ°è¢«ç†è§£å’Œæ”¯æŒã€‚

å‰µæ„è¡¨é”é¢¨æ ¼ï¼š
- èªè¨€è¦æº«æš–ã€æ­£é¢ã€æœ‰å¸Œæœ›
- å¤šç”¨æ¯”å–»ã€æ•…äº‹å’Œå…·é«”ä¾‹å­
- é¿å…éæ–¼æŠ€è¡“æ€§çš„è¡“èª
- è®“æ¯å€‹äººéƒ½èƒ½æ„Ÿå—åˆ°è‡ªå·±çš„ç¨ç‰¹åƒ¹å€¼
- æä¾›å¯è¡Œçš„äººç”Ÿå»ºè­°

è«‹è®“é€™ä»½åˆ†ææˆç‚ºä¸€ä»½å……æ»¿æº«åº¦å’Œæ™ºæ…§çš„äººç”ŸæŒ‡å—ã€‚
"""
        
        return base_prompt
    
    def get_creative_discussion_prompt(self, topic: str, other_viewpoints: List[str]) -> str:
        """ç²å–å‰µæ„è¨è«–æç¤ºè©"""
        return f"""
é‡å°ä»¥ä¸‹ç´«å¾®æ–—æ•¸åˆ†æä¸»é¡Œï¼Œè«‹æä¾›å‰µæ„å’Œäººæ€§åŒ–çš„è§€é»ï¼š

ä¸»é¡Œï¼š{topic}

å…¶ä»–å°ˆå®¶çš„è§€é»ï¼š
{chr(10).join([f"- {viewpoint}" for viewpoint in other_viewpoints])}

è«‹å¾å‰µæ„è¡¨é”çš„è§’åº¦ï¼š
1. ç”¨ç”Ÿå‹•çš„æ¯”å–»é‡æ–°è©®é‡‹ä¸»é¡Œ
2. æä¾›ä¸åŒçš„äººæ€§åŒ–è¦–è§’
3. åˆ†äº«å•Ÿç™¼æ€§çš„æ•…äº‹æˆ–æ¡ˆä¾‹
4. è£œå……æº«æš–å’Œæ­£é¢çš„è¦‹è§£
5. æä¾›å¯¦ç”¨çš„äººç”Ÿå»ºè­°

ä¿æŒæº«æš–ã€æ­£é¢ã€å¯Œæœ‰å‰µæ„çš„è¡¨é”é¢¨æ ¼ã€‚
"""
    
    def get_formatting_prompt(self, content: str, output_format: str, style: str = "professional") -> str:
        """ç²å–æ ¼å¼åŒ–æç¤ºè©"""
        return f"""
è«‹å°‡ä»¥ä¸‹å…§å®¹æ ¼å¼åŒ–ç‚º {output_format} æ ¼å¼ï¼Œé¢¨æ ¼ç‚º {style}ï¼š

åŸå§‹å…§å®¹ï¼š
{content}

æ ¼å¼åŒ–è¦æ±‚ï¼š
1. ä¿æŒå…§å®¹çš„æ ¸å¿ƒä¿¡æ¯å’Œæ´å¯Ÿ
2. æ ¹æ“šæ ¼å¼è¦æ±‚èª¿æ•´çµæ§‹å’Œè¡¨é”
3. ç¢ºä¿å¯è®€æ€§å’Œç¾è§€æ€§
4. æ·»åŠ é©ç•¶çš„æ¨™è¨˜å’Œåˆ†æ®µ
5. ä¿æŒæº«æš–å’Œæ­£é¢çš„èªèª¿

è«‹ä½¿ç”¨æ ¼å¼åŒ–å·¥å…·å®Œæˆé€™å€‹ä»»å‹™ã€‚
"""

def create_gpt_agent(logger=None) -> Agent:
    """å‰µå»º GPT Agent çš„ä¾¿æ·å‡½æ•¸"""
    gpt_agent = GPTZiweiAgent(logger=logger)
    return gpt_agent.get_agent()
