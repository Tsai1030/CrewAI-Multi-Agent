# ç´«å¾®æ–—æ•¸ RAG å‘é‡åº«ç³»çµ±

åŸºæ–¼ Hugging Face BGE-M3 åµŒå…¥æ¨¡å‹å’Œ GPT-4o è¼¸å‡ºæ¨¡å‹çš„æª¢ç´¢å¢å¼·ç”Ÿæˆï¼ˆRAGï¼‰ç³»çµ±ï¼Œå°ˆç‚ºç´«å¾®æ–—æ•¸çŸ¥è­˜å•ç­”å’Œå‘½ç›¤åˆ†æè¨­è¨ˆã€‚

## ğŸŒŸ ç³»çµ±ç‰¹è‰²

- **ğŸ”¥ å…ˆé€²çš„åµŒå…¥æ¨¡å‹**: ä½¿ç”¨ BGE-M3 å¤šèªè¨€åµŒå…¥æ¨¡å‹ï¼Œæ”¯æ´ä¸­æ–‡èªç¾©ç†è§£
- **ğŸ¤– å¼·å¤§çš„ç”Ÿæˆèƒ½åŠ›**: æ•´åˆ GPT-4o æ¨¡å‹ï¼Œæä¾›å°ˆæ¥­çš„ç´«å¾®æ–—æ•¸è§£æ
- **ğŸ“š æ™ºèƒ½çŸ¥è­˜æª¢ç´¢**: ChromaDB å‘é‡è³‡æ–™åº«ï¼Œå¿«é€Ÿç²¾æº–çš„èªç¾©æœç´¢
- **ğŸ”„ æ··åˆæ¨¡å‹æ”¯æŒ**: æ”¯æ´ BGE-M3 å’Œ OpenAI åµŒå…¥æ¨¡å‹çš„ç„¡ç¸«åˆ‡æ›
- **âš¡ é«˜æ€§èƒ½å„ªåŒ–**: æ”¯æ´ GPU åŠ é€Ÿå’Œæ‰¹æ¬¡è™•ç†
- **ğŸ› ï¸ æ˜“æ–¼ä½¿ç”¨**: ç°¡æ½”çš„ API è¨­è¨ˆï¼Œå¿«é€Ÿä¸Šæ‰‹

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ¶æŸ¥è©¢      â”‚â”€â”€â”€â–¶â”‚   BGE-M3 åµŒå…¥    â”‚â”€â”€â”€â–¶â”‚   å‘é‡æœç´¢      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GPT-4o å›ç­”   â”‚â—€â”€â”€â”€â”‚   ä¸Šä¸‹æ–‡æ•´åˆ     â”‚â—€â”€â”€â”€â”‚   æª¢ç´¢çµæœ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ å®‰è£ä¾è³´

```bash
# å®‰è£ Python ä¾è³´
pip install -r requirements.txt

# æˆ–æ‰‹å‹•å®‰è£é—œéµåŒ…
pip install transformers torch tokenizers chromadb openai langchain
```

## âš™ï¸ ç’°å¢ƒé…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­è¨­ç½®ä»¥ä¸‹ç’°å¢ƒè®Šæ•¸ï¼š

```env
# OpenAI API è¨­å®š
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_MODEL_GPT4O=gpt-4o-mini

# BGE-M3 åµŒå…¥æ¨¡å‹è¨­å®š
EMBEDDING_MODEL=BAAI/bge-m3
EMBEDDING_PROVIDER=huggingface
EMBEDDING_DEVICE=cpu
EMBEDDING_MAX_LENGTH=8192
EMBEDDING_BATCH_SIZE=32

# å‘é‡è³‡æ–™åº«è¨­å®š
VECTOR_DB_PATH=./data/vector_db
VECTOR_DB_COLLECTION=ziwei_knowledge
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. åŸºæœ¬ä½¿ç”¨

```python
from src.rag import create_rag_system

# å‰µå»º RAG ç³»çµ±
rag_system = create_rag_system()

# æª¢æŸ¥ç³»çµ±ç‹€æ…‹
status = rag_system.get_system_status()
print(f"ç³»çµ±ç‹€æ…‹: {status['system']}")
```

### 2. æ·»åŠ çŸ¥è­˜

```python
# æ·»åŠ ç´«å¾®æ–—æ•¸çŸ¥è­˜
knowledge = [
    {
        "content": "ç´«å¾®æ˜Ÿæ˜¯ç´«å¾®æ–—æ•¸ä¸­çš„å¸ç‹æ˜Ÿï¼Œä»£è¡¨é ˜å°èƒ½åŠ›...",
        "metadata": {
            "category": "ä¸»æ˜Ÿè§£æ",
            "star": "ç´«å¾®æ˜Ÿ"
        }
    }
]

rag_system.add_knowledge(knowledge)
```

### 3. æ™ºèƒ½å•ç­”

```python
# æå•ä¸¦ç²å¾—å›ç­”
response = rag_system.generate_answer("ç´«å¾®æ˜Ÿåå‘½çš„äººæœ‰ä»€éº¼ç‰¹è³ªï¼Ÿ")
print(response['answer'])
```

### 4. å‘½ç›¤åˆ†æ

```python
# åˆ†æç´«å¾®æ–—æ•¸å‘½ç›¤
chart_data = {
    "main_stars": ["ç´«å¾®æ˜Ÿ", "å¤©æ©Ÿæ˜Ÿ"],
    "palaces": ["å‘½å®®", "è²¡å¸›å®®"],
    # ... æ›´å¤šå‘½ç›¤æ•¸æ“š
}

analysis = rag_system.analyze_ziwei_chart(chart_data)
print(analysis['answer'])
```

## ğŸ“ é …ç›®çµæ§‹

```
src/rag/
â”œâ”€â”€ __init__.py              # æ¨¡çµ„å°å…¥
â”œâ”€â”€ rag_system.py           # ä¸»è¦ RAG ç³»çµ±
â”œâ”€â”€ vector_store.py         # å‘é‡å­˜å„²å¯¦ç¾
â”œâ”€â”€ bge_embeddings.py       # BGE-M3 åµŒå…¥æ¨¡å‹
â”œâ”€â”€ gpt4o_generator.py      # GPT-4o ç”Ÿæˆå™¨
â””â”€â”€ ...

examples/
â”œâ”€â”€ rag_demo.py             # å®Œæ•´æ¼”ç¤ºè…³æœ¬
â””â”€â”€ ...

docs/
â”œâ”€â”€ rag_setup_guide.md      # è©³ç´°è¨­ç½®æŒ‡å—
â””â”€â”€ ...

quick_start.py              # å¿«é€Ÿé–‹å§‹ç¤ºä¾‹
test_rag_system.py          # ç³»çµ±æ¸¬è©¦è…³æœ¬
```

## ğŸ”§ é«˜ç´šé…ç½®

### è‡ªå®šç¾©åµŒå…¥æ¨¡å‹

```python
custom_config = {
    "vector_store": {
        "embedding_provider": "huggingface",
        "embedding_model": "BAAI/bge-m3",
        "embedding_config": {
            "device": "cuda",        # ä½¿ç”¨ GPU
            "max_length": 8192,
            "batch_size": 64,
            "use_fp16": True,        # åŠç²¾åº¦åŠ é€Ÿ
            "openai_fallback": True  # OpenAI å‚™ç”¨
        }
    }
}

rag_system = create_rag_system(custom_config)
```

### æ··åˆåµŒå…¥æ¨¡å‹

ç³»çµ±æ”¯æ´ BGE-M3 å’Œ OpenAI åµŒå…¥æ¨¡å‹çš„æ··åˆä½¿ç”¨ï¼Œç•¶ä¸»è¦æ¨¡å‹å¤±æ•—æ™‚è‡ªå‹•åˆ‡æ›åˆ°å‚™ç”¨æ¨¡å‹ã€‚

### æ€§èƒ½å„ªåŒ–

- **GPU åŠ é€Ÿ**: è¨­ç½® `device="cuda"` ä½¿ç”¨ GPU
- **æ‰¹æ¬¡è™•ç†**: èª¿æ•´ `batch_size` æé«˜ååé‡
- **åŠç²¾åº¦**: å•Ÿç”¨ `use_fp16=True` ç¯€çœå…§å­˜
- **ä¸¦è¡Œè™•ç†**: æ”¯æ´å¤šç·šç¨‹æ–‡æª”è™•ç†

## ğŸ§ª æ¸¬è©¦ç³»çµ±

é‹è¡Œå®Œæ•´çš„ç³»çµ±æ¸¬è©¦ï¼š

```bash
python test_rag_system.py
```

é‹è¡Œå¿«é€Ÿé–‹å§‹ç¤ºä¾‹ï¼š

```bash
python quick_start.py
```

é‹è¡Œå®Œæ•´æ¼”ç¤ºï¼š

```bash
python examples/rag_demo.py
```

## ğŸ“Š æ€§èƒ½æŒ‡æ¨™

| çµ„ä»¶ | æ€§èƒ½æŒ‡æ¨™ |
|------|----------|
| BGE-M3 åµŒå…¥ | ~1024 ç¶­å‘é‡ï¼Œæ”¯æ´ 8192 token |
| å‘é‡æœç´¢ | æ¯«ç§’ç´šéŸ¿æ‡‰ï¼Œæ”¯æ´ç™¾è¬ç´šæ–‡æª” |
| GPT-4o ç”Ÿæˆ | é«˜è³ªé‡å›ç­”ï¼Œæ”¯æ´é•·ä¸Šä¸‹æ–‡ |
| æ•´é«”å»¶é² | é€šå¸¸ 2-5 ç§’ï¼ˆåŒ…å«æª¢ç´¢å’Œç”Ÿæˆï¼‰ |

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **BGE-M3 æ¨¡å‹ä¸‹è¼‰å¤±æ•—**
   ```bash
   huggingface-cli download BAAI/bge-m3
   ```

2. **CUDA å…§å­˜ä¸è¶³**
   ```python
   # ä½¿ç”¨ CPU æˆ–æ¸›å°‘æ‰¹æ¬¡å¤§å°
   config = {"embedding_config": {"device": "cpu", "batch_size": 8}}
   ```

3. **OpenAI API èª¿ç”¨å¤±æ•—**
   - æª¢æŸ¥ API å¯†é‘°è¨­ç½®
   - ç¢ºèªç¶²çµ¡é€£æ¥
   - æª¢æŸ¥ API é…é¡

### èª¿è©¦æ¨¡å¼

```python
import logging
logging.basicConfig(level=logging.DEBUG)

# å‰µå»ºç³»çµ±æ™‚æœƒè¼¸å‡ºè©³ç´°æ—¥èªŒ
rag_system = create_rag_system()
```

## ğŸ“š æ–‡æª”å’Œç¤ºä¾‹

- [è©³ç´°è¨­ç½®æŒ‡å—](docs/rag_setup_guide.md)
- [å®Œæ•´æ¼”ç¤ºè…³æœ¬](examples/rag_demo.py)
- [å¿«é€Ÿé–‹å§‹ç¤ºä¾‹](quick_start.py)
- [ç³»çµ±æ¸¬è©¦è…³æœ¬](test_rag_system.py)

## ğŸ¤ è²¢ç»æŒ‡å—

æ­¡è¿æäº¤ Issue å’Œ Pull Requestï¼

1. Fork é …ç›®
2. å‰µå»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. ç™¼èµ· Pull Request

## ğŸ“„ è¨±å¯è­‰

æœ¬é …ç›®æ¡ç”¨ MIT è¨±å¯è­‰ã€‚

## ğŸ™ è‡´è¬

- [BGE-M3](https://huggingface.co/BAAI/bge-m3) - å„ªç§€çš„å¤šèªè¨€åµŒå…¥æ¨¡å‹
- [OpenAI GPT-4o](https://openai.com/) - å¼·å¤§çš„èªè¨€ç”Ÿæˆæ¨¡å‹
- [ChromaDB](https://www.trychroma.com/) - é«˜æ•ˆçš„å‘é‡è³‡æ–™åº«
- [LangChain](https://langchain.com/) - ä¾¿æ·çš„ LLM æ‡‰ç”¨æ¡†æ¶

---

**é–‹å§‹ä½¿ç”¨**: `python quick_start.py`

**å®Œæ•´æ¸¬è©¦**: `python test_rag_system.py`

**è©³ç´°æ¼”ç¤º**: `python examples/rag_demo.py`
